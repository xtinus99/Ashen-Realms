<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>World Map</title>
<link rel="stylesheet" href="vendor/css/leaflet.css">
<style>
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body { background: #0a0a12; overflow: hidden; height: 100vh; }

  #map { width: 100%; height: 100vh; }

  .map-marker {
    border-radius: 50%;
    border: 2px solid;
    cursor: pointer;
    box-shadow: 0 0 6px rgba(0,0,0,0.6);
  }
  .map-marker:hover {
    transform: scale(1.3);
    z-index: 1000 !important;
  }
  .map-marker.type-sovereign {
    background: radial-gradient(circle, #8b1a1a, #4a0e0e);
    border-color: #d4a84b;
  }
  .map-marker.type-city {
    background: radial-gradient(circle, #8a6a30, #5a4218);
    border-color: #c9a84c;
  }
  .map-marker.type-landmark {
    background: radial-gradient(circle, #4a6a8a, #2a3e54);
    border-color: #7aaabe;
  }
  .map-marker.party-location {
    animation: party-pulse 2s ease-in-out infinite;
  }
  .map-marker.party-location::after {
    content: '';
    position: absolute;
    top: 50%;
    left: 50%;
    width: 30px;
    height: 30px;
    border-radius: 50%;
    border: 2px solid #d4a84b;
    transform: translate(-50%, -50%);
    animation: pulse-ring 2s ease-out infinite;
    pointer-events: none;
  }
  @keyframes party-pulse {
    0%, 100% { box-shadow: 0 0 6px rgba(212,168,75,0.4); }
    50% { box-shadow: 0 0 14px rgba(212,168,75,0.8); }
  }
  @keyframes pulse-ring {
    0% { width: 18px; height: 18px; opacity: 1; }
    100% { width: 40px; height: 40px; opacity: 0; }
  }

  /* Popups */
  .leaflet-popup-content-wrapper {
    background: #151210 !important;
    border: 1px solid #d4a84b !important;
    border-radius: 6px !important;
    box-shadow: 0 4px 20px rgba(0,0,0,0.6) !important;
  }
  .leaflet-popup-tip { background: #151210 !important; }
  .leaflet-popup-content { margin: 0 !important; }
  .leaflet-popup-close-button { color: #6a5a44 !important; font-size: 18px !important; }

  .map-popup { padding: 12px 14px; min-width: 200px; max-width: 300px; font-family: 'Segoe UI', system-ui, sans-serif; font-size: 13px; line-height: 1.5; color: #c4b89a; }
  .map-popup-name { font-size: 15px; font-weight: 700; color: #d4a84b; margin-bottom: 2px; }
  .map-popup-subtitle { font-style: italic; color: #6a5a44; font-size: 12px; margin-bottom: 4px; }
  .map-popup-sovereign { font-size: 12px; color: #c43c3c; margin-bottom: 6px; }
  .map-popup-party { color: #d4a84b; font-size: 12px; margin-bottom: 4px; }
  .map-popup-desc { color: #a89a84; margin-bottom: 10px; border-top: 1px solid #2a2218; padding-top: 8px; }
  .map-popup-link { display: inline-block; color: #d4a84b; font-size: 12px; text-decoration: none; cursor: pointer; }
  .map-popup-link:hover { text-decoration: underline; }

  /* Legend */
  .map-legend {
    position: fixed;
    bottom: 16px;
    right: 16px;
    background: rgba(10,10,18,0.9);
    border: 1px solid #2a2218;
    border-radius: 6px;
    padding: 10px 14px;
    z-index: 1000;
    font-family: 'Segoe UI', system-ui, sans-serif;
    font-size: 12px;
    color: #8a7a64;
  }
  .map-legend-title { font-weight: 600; color: #c4b89a; margin-bottom: 6px; }
  .map-legend-item { display: flex; align-items: center; gap: 8px; margin-bottom: 4px; }
  .map-legend-dot { width: 10px; height: 10px; border-radius: 50%; border: 2px solid; flex-shrink: 0; }
  .map-legend-dot.sovereign { background: #8b1a1a; border-color: #d4a84b; }
  .map-legend-dot.city { background: #8a6a30; border-color: #c9a84c; }
  .map-legend-dot.landmark { background: #4a6a8a; border-color: #7aaabe; }
  .map-legend-dot.party { background: #8b1a1a; border-color: #d4a84b; box-shadow: 0 0 4px #d4a84b; }

  /* Coord toast */
  .map-coord-toast {
    position: fixed;
    bottom: 20px;
    left: 50%;
    transform: translateX(-50%) translateY(60px);
    background: #1e1a14;
    border: 1px solid #d4a84b;
    color: #d4a84b;
    padding: 8px 20px;
    border-radius: 4px;
    font-size: 13px;
    font-family: 'Segoe UI', system-ui, sans-serif;
    z-index: 2000;
    transition: transform 0.3s ease;
    pointer-events: none;
  }
  .map-coord-toast.visible { transform: translateX(-50%) translateY(0); }

  .map-hint {
    position: fixed;
    top: 12px;
    right: 12px;
    background: rgba(10,10,18,0.85);
    border: 1px solid #2a2218;
    border-radius: 4px;
    padding: 6px 10px;
    z-index: 1000;
    font-family: 'Segoe UI', system-ui, sans-serif;
    font-size: 11px;
    color: #5a4a34;
  }

  .leaflet-container { background: #0a0a12 !important; }
  .leaflet-control-zoom a { background: #151210 !important; color: #c4b89a !important; border-color: #2a2218 !important; }
  .leaflet-control-zoom a:hover { background: #1e1a14 !important; color: #d4a84b !important; }
  .leaflet-control-attribution { display: none !important; }
</style>
</head>
<body>
<div id="map"></div>

<div class="map-legend">
  <div class="map-legend-title">Legend</div>
  <div class="map-legend-item"><div class="map-legend-dot sovereign"></div><span>Sovereign Domain</span></div>
  <div class="map-legend-item"><div class="map-legend-dot city"></div><span>Independent City</span></div>
  <div class="map-legend-item"><div class="map-legend-dot landmark"></div><span>Landmark</span></div>
  <div class="map-legend-item"><div class="map-legend-dot party"></div><span>Party Location</span></div>
</div>

<div class="map-hint">Shift+Click to get coordinates</div>
<div class="map-coord-toast" id="toast"></div>

<script src="vendor/js/leaflet.js"></script>
<script>
(function() {
  const IMG_W = 1536, IMG_H = 1024;

  const map = L.map('map', {
    crs: L.CRS.Simple,
    minZoom: -1,
    maxZoom: 3,
    zoomSnap: 0.5,
    zoomDelta: 0.5,
    doubleClickZoom: false,
    attributionControl: false
  });

  const bounds = [[0, 0], [IMG_H, IMG_W]];
  L.imageOverlay('images/world-map.webp', bounds).addTo(map);
  map.fitBounds(bounds);
  map.setMaxBounds([[-100, -100], [IMG_H + 100, IMG_W + 100]]);

  fetch('map-data.json?v=' + Date.now())
    .then(r => r.json())
    .then(data => {
      const partyId = data.partyLocation;
      data.markers.forEach(marker => {
        const isParty = marker.id === partyId;
        const type = marker.type || 'landmark';
        const size = type === 'landmark' ? 14 : 18;

        const icon = L.divIcon({
          className: 'map-marker type-' + type + (isParty ? ' party-location' : ''),
          iconSize: [size, size],
          iconAnchor: [size/2, size/2],
          popupAnchor: [0, -(size/2 + 4)]
        });

        const lm = L.marker(marker.coords, { icon: icon }).addTo(map);

        let html = '<div class="map-popup">';
        html += '<div class="map-popup-name">' + esc(marker.name) + '</div>';
        if (marker.subtitle) html += '<div class="map-popup-subtitle">' + esc(marker.subtitle) + '</div>';
        if (marker.sovereign) html += '<div class="map-popup-sovereign">' + esc(marker.sovereign) + '</div>';
        if (isParty) html += '<div class="map-popup-party">&#9733; Party is here</div>';
        if (marker.description) html += '<div class="map-popup-desc">' + esc(marker.description) + '</div>';
        if (marker.link) {
          html += '<a class="map-popup-link" data-category="' + marker.link.category + '" data-id="' + marker.link.id + '">Open in Compendium &rarr;</a>';
        }
        html += '</div>';

        lm.bindPopup(html, { maxWidth: 300, minWidth: 200 });

        // Compendium links communicate with parent
        lm.on('popupopen', () => {
          const link = lm.getPopup().getElement().querySelector('.map-popup-link');
          if (link) {
            link.addEventListener('click', (e) => {
              e.preventDefault();
              window.parent.postMessage({
                type: 'map-navigate',
                category: link.dataset.category,
                id: link.dataset.id
              }, '*');
            });
          }
        });
      });
    });

  // Shift+Click coordinate helper
  const toast = document.getElementById('toast');
  map.on('click', function(e) {
    if (e.originalEvent.shiftKey) {
      const lat = Math.round(e.latlng.lat);
      const lng = Math.round(e.latlng.lng);
      const text = '[' + lat + ', ' + lng + ']';
      toast.textContent = 'Coords: ' + text + ' (copied!)';
      toast.classList.add('visible');
      navigator.clipboard.writeText(text).catch(function(){});
      setTimeout(function() { toast.classList.remove('visible'); }, 2500);
    }
  });

  function esc(s) {
    if (!s) return '';
    var d = document.createElement('div');
    d.textContent = s;
    return d.innerHTML;
  }
})();
</script>
</body>
</html>
